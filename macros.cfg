##########################################################################################################################################################
#                    MACROS
##########################################################################################################################################################

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#               PRESSURE ADVANCE 
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# This will just set a default value for PA per filament temp. 
# If PS/SS filament gcode sets pressure advance, it will take precendence over this, as it runs after.
# Pretty hacky way to do it, but it works. Better way would probably be to pass filament type as a variable.

[gcode_macro TEMPADJUSTPA]
gcode:
	# ABS
	{% if printer.heater_bed.target >= 100 %}
		SET_PRESSURE_ADVANCE ADVANCE=0.07
	## PETG
	{% elif printer.heater_bed.target > 65 and printer.heater_bed.target < 100 %}
		SET_PRESSURE_ADVANCE ADVANCE=0.00
	# PLA
	{% elif printer.heater_bed.target <= 65 %}
		SET_PRESSURE_ADVANCE ADVANCE=0.00
	# Catch-all
	{% else %}
		SET_PRESSURE_ADVANCE ADVANCE=0.07
  {% endif %}

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                  START
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro PRINT_START]
# For setting the parameters as persistent variables so they can be referenced in PRINT_START2
variable_bedtemp: 0
variable_hotendtemp: 0
variable_chambertemp: 0
gcode:		
	# Parameters
	{% set bed = params.BED|int %}
	{% set hotend = params.HOTEND|int %}
	{% set chamber = params.CHAMBER|default(0)|int %}

	# Set the parameters as persistent variables so they can be referenced outside of the macro (in PRINT_END)
	SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=bedtemp VALUE={bed}	
	SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=hotendtemp VALUE={hotend}	
	SET_GCODE_VARIABLE MACRO=PRINT_START VARIABLE=chambertemp VALUE={chamber}	
	
  #UPDATE_DELAYED_GCODE ID=EXHAUST_OFF DURATION=0  													    ; cancel exhaust off timer (if there is one)
	UPDATE_DELAYED_GCODE ID=DELAYED_OFF DURATION=0      												; cancel off timer (if there is one)
	SET_PIN PIN=caselight VALUE=1																		; turn on case light
	RESETSPEEDS																							; reset speed, accel etc to configured values
	#RESETRGB																							; reset LCD RGB
	M104 S160																							; set hotend to no-ooze temp
	M140 S{bed}																							; set bed to target temp
	G28																									; home
	G90																									; absolute positioning
	{% if printer["temperature_sensor chamber"].temperature < chamber %}								; - if chamber is not at temp yet:
		HEATSOAK T={bed} MOVE=1																			; 	heatsoak macro + park in center
		M190 S{bed} 																					; 	wait for bed final temp
		TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={chamber}							; 	wait for chamber final temp
	{% else %}																							; - if chamber is already at temp:
		{% if printer.heater_bed.temperature < (bed-2) %}												; -- but bed is not fully heated (within 2C):
			HEATSOAK T={bed} MOVE=1																		; 		heatsoak and park
			M190 S{bed} 																				; 		wait for bed final temp
		{% else %}																						; -- and bed is already heated:
			HEATSOAK T={bed} MOVE=0																		; 		"heatsoak" without parking (only still calling this because it does some other things like turn off exahaust fan)
		{% endif %}
	{% endif %}	
	M106 S0		                                                                                        ; turn off part cooling fan (from heatsoak)
    # <insert routines>
    NEVERMORE_ADJUST                                                                                    ; temp based bed fans setting
    PRINT_MESH                                                                                          ; combined homing, z_tilt, bed_mesh_calibrate from euclif
    M109 S{hotend}                                                                                      ; wait for hotend temp
    CLEANNOZZLE                                                                                         ; brush nozzle
    TEMPADJUSTPA                                                                                        ; temp based pressure advance setting
    CALIBRATE_Z                                                                                         ; final z homing with hot nozzle
    SWIPENOZZLE                                                                                         ; final nozzle brush before printing
    PRIME_LINE                                                                                          ; prime extruder

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro PRIME_LINE]
description: Print an easy to remove parametric extruder priming line with a built-in handle.
gcode:
    # settings
    {% set line = {
      'x_padding'      : params.XPAD|default(0)|float,                                                                                         # left/right padding around the bed the line can't print into
      'y_padding'      : params.YPAD|default(0)|float,                                                                                         # top/bottom padding around the bed the line can't print into
      'initial_purge'  : params.PURGE|default(12)|int,                                                                                         # mm of filament to purge before printing. set to 0 to disable
      'retract_after'  : params.RETRACT|default(0.5)|int,                                                                                        # mm of filament to recract after printing. set to 0 to disable
      'length'         : params.LENGTH|default(150)|int,
      'print_speed'    : params.PRINT_SPEED|default(30)|int,
      'travel_speed'   : params.TRAVEL_SPEED|default(300)|int,
      'extr_multi'     : params.EXTRUSION_MULTIPLIER|default(1.25)|float,                                                                       # apply to prime lines
      'overlap_percent': 80,                                                                                                                    # how much prime lines overlap each other
    } %}
    {% set handle = {
      'do_print'    : params.PRINT_HANDLE|default(0)|int,                                                                                       # set to 0 to disable printing the handle
      'fan_percent' : params.HANDLE_FAN|default(40)|int,                                                                                        # without fan the handle is too small and melty to print upright
      'width'       : 5.0,
      'height'      : 5.0,
      'move_away'   : 60                                                                                                                        # how much to move the toolhead away from the printed handle once done. set 0 to disable
    } %}

    # sanity check and computed variables
    {% set max_x, max_y, nozzle_diameter = printer.toolhead.axis_maximum.x|float, printer.toolhead.axis_maximum.y|float, printer.configfile.config['extruder'].nozzle_diameter|float %}
    {% set _ = line.update({'width': nozzle_diameter * 1.25, 'height': nozzle_diameter / 2, 'length': [line.length, max_x - 2 * line.x_padding - 2]|min}) %}
    {% set _ = line.update({'e_per_mm': line.extr_multi * (line.width * line.height) / (3.1415 * (1.75/2)**2), 'x_start': max_x / 2 - line.length / 2, 'y_start': line.y_padding})  %}

    SAVE_GCODE_STATE NAME=STATE_PRIME_LINE

    M117 Prime Line
    G90                                                                                                                                           # absolute positioning
    G0 X{line.x_start} Y{line.y_start + (handle.width / 2)|int + 1} Z{line.height} F{line.travel_speed * 60}                                      # move to starting position
    G91                                                                                                                                           # relative positioning
    G1 E{line.initial_purge} F{5 * 60}                                                                                                            # extrude at ~12mm3/sec
    G0 F{line.print_speed * 60}                                                                                                                   # set print speed
    G1 X{line.length} E{line.length * line.e_per_mm}                                                                                              # print forward line
    G0 Y{line.width * line.overlap_percent / 100}                                                                                                 # overlap forward line
    G1 X-{line.length / 2} E{(line.length / 2) * line.e_per_mm}                                                                                   # print backward line for half the length

    # print a handle for easy removal
    {% if handle.do_print != 0 and handle.width != 0 and handle.height != 0 %}
      G0 X{handle.width} Y{handle.width / 2}                                                                                                      # move into position for printing handle
      {% set saved_fan_speed = (printer['fan'].speed * 256)|int %}
      M106 S{((handle.fan_percent / 100) * 256)|int}                                                                                              # set part fan to desired speed
      {% for _ in range((line.height * 1000)|int, (handle.height * 1000)|int, (line.height * 1000)|int) %}                                        # loop however many cycles it takes to print required handle height
        G1 Y{loop.cycle(-1.0, 1.0) * handle.width} E{handle.width * line.e_per_mm}                                                                # handle layer
        G0 X-{line.width * 0.2} Z{line.height}                                                                                                    # move up and shift the layer to make the handle sloping
      {% endfor %}
      M106 S{saved_fan_speed}                                                                                                                     # restore previous part fan speed
    {% endif %}
    
    G1 E-{line.retract_after} F{50 * 60}                                                                                                          # retract ar 50mm/sec after printing
    G0 Y{handle.move_away} F{line.travel_speed * 60}
    M117

    RESTORE_GCODE_STATE NAME=STATE_PRIME_LINE                     																; move Z Axis up

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                  END/CANCEL
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro PRINT_END]
gcode:
	#RESETRGB																							; revert LCD RGB
	#SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0												; disable filament sensor
	CLEAR_PAUSE																							; clear pause (from M191) if there is one
	{% if printer.heater_bed.temperature >= 100 %}												
		SET_FAN_SPEED FAN=nevermore SPEED=1  															; crank exhaust fan to 100% to evacuate chamber
        SET_FAN_SPEED FAN=BedFans SPEED=0				                                                ; bed fan off
	{% endif %}													
	M400                         	   																	; wait for buffer to clear
    M107                         	   			 	 													; turn off part cooling fan
    G90                           	    			 													; absolute positioning
	G1 X{printer.toolhead.axis_maximum.x-10} Y{printer.toolhead.axis_maximum.y-10} F18000.0  			; park nozzle at rear
	G92 E0                        	    																; zero the extruder
    FORM_TIP                                                                                            ; retract filament
	M104 S0						 	    			 													; turn only the hotend off
	#M140 S{printer["gcode_macro PRINT_START"].bedtemp|int}												; return the bed to temp, some slicers like to turn it off
    M140 S0                                                                                             ; turn only the bed off 
	G91                             							 										; relative positioning
    G1 Z5 F3000                  	    			 													; move nozzle up 5mm
    G90
	BED_MESH_CLEAR																						; clear bed mesh									
	UPDATE_DELAYED_GCODE ID=NEVERMORE_OFF DURATION=180													; turn exhaust off in 3 min
	UPDATE_DELAYED_GCODE ID=DELAYED_OFF DURATION=1800	 												; turn everything off in 30 min
	RESETSPEEDS																							; reset speed, accel etc to configured max values
	#SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=0														; disable XYE steppers (not z)
    #SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=0
    #SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
	#BEEP I=3	


############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  SDCARD_RESET_FILE
  PRINT_END
  CANCEL_PRINT_BASE

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                  PAUSE / FILAMENT CHANGE / RESUME
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
	# Parameters
	{% set z = params.Z|default(10)|int %}																					; z hop amount
	
	{% if printer['pause_resume'].is_paused|int == 0 %}		
		SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}									    						; set z hop variable for reference in resume macro
		SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}									; set hotend temp variable for reference in resume macro
								
		SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0																	; disable filament sensor		
		SAVE_GCODE_STATE NAME=PAUSE																							; save current print position for resume				
		BASE_PAUSE																											; pause print
		{% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}										; check that zhop doesn't exceed z max
			G91																												; relative positioning
			G1 Z{z} F900																									; raise Z up by z hop amount
		{% else %}
			{ action_respond_info("Pause zhop exceeds maximum Z height.") }													; if z max is exceeded, show message and set zhop value for resume to 0
			SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
		{% endif %}
		G90																													; absolute positioning
		G1 X275 Y312 F18000									                                                                ; park toolhead at front center
        FORM_TIP
        SAVE_GCODE_STATE NAME=PAUSEPARK																						; save parked position in case toolhead is moved during the pause (otherwise the return zhop can error)	
		#M104 S0																												; turn off hotend
		SET_IDLE_TIMEOUT TIMEOUT=43200															    						; set timeout to 12 hours
	{% endif %}


############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Return Z hop back down 10mm, prime nozzle, resume print.
[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_zhop: 0
variable_etemp: 0
gcode:
	# Parameters
	{% set e = params.E|default(2.5)|int %}
	
	{% if printer['pause_resume'].is_paused|int == 1 %}
		#SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1																; enable filament sensor
		#RESETRGB																											; reset LCD color
		SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}											; set timeout back to configured value
		{% if etemp > 0 %}
			M109 S{etemp|int}																								; wait for hotend to heat back up
		{% endif %}
        FILAMENT_PURGE
        SWIPENOZZLE
		RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=450															; go back to parked position in case toolhead was moved during pause (otherwise the return zhop can error)	
		#G91																													; relative positioning
		#M83																													; relative extruder positioning
		#{% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}												
		#	G1 Z{zhop * -1} E{e} F900																						; prime nozzle by E, lower Z back down
		#{% else %}						
		#	G1 Z{zhop * -1} F900																							; lower Z back down	without priming (just in case we are testing the macro with cold hotend)
		#{% endif %}								
		RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=450																; restore position
		BASE_RESUME																											; resume print
	{% endif %}


############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Filament runout / change alias	
[gcode_macro M600]
gcode:
	#LCDRGB R=0 G=1 B=0	# Turn LCD green
	PAUSE


############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# StandAlone cooling moves to extract proper filament tip
[gcode_macro FORM_TIP]
gcode:
    G91
    G92 E0
    G1 E-9.05 F1200
    G1 E0.68 F165
    G1 E0.70 F168
    G1 E0.73 F177
    G1 E0.78 F189
    G1 E0.82 F197
    G1 E0.84 F204
    G1 E0.90 F216
    G1 E0.97 F234
    G1 E1.02 F246
    G1 E1.04 F250
    G1 E-15.00 F6000.0
    G1 E-24.50 F5400.0
    G1 E-7.00 F2700.0
    G1 E-3.50 F1620.0
    G1 E20.00 F900.0
    G1 E-13 F500.0
    G1 E13 F400.0
    G1 E-11 F500.0
    G1 E11 F400.0
    G1 E-2.00 F50.0
    G1 E-4.00 F1200.0
    G1 E-10.00 F2000
    G92 E0

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                  FILAMENT
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro LOAD_FILAMENT]
gcode:
	SAVE_GCODE_STATE NAME=LOADFILAMENT
	M83 ; set extruder to relative
	G1 E200 F300
	RESTORE_GCODE_STATE NAME=LOADFILAMENT

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro UNLOAD_FILAMENT]
gcode:
  SAVE_GCODE_STATE NAME=UNLOADFILAMENT
	M83                                                                         ; set extruder to relative
	G1 E10 F300                                                                 ; extrude a little to soften tip 
	FORM_TIP                         ; retract filament completely
	RESTORE_GCODE_STATE NAME=UNLOADFILAMENT

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro FILAMENT_PURGE]
gcode:
#   G0 X192 Y75 F9000
  {% if printer.extruder.can_extrude|lower == 'true' %}
    M83
    G92 E0.0
    G1 E100 F300
    G92 E0.0
  {% else %}
    {action_respond_info("Extruder not hot enough")}
  {% endif %}

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro HOT_UNLOAD]
gcode:
	# Parameters
	{% set t = params.T|default(240)|int %}
	
	M104 S{t}
	PARKPURGE
	M109 S{t}
    UNLOAD_FILAMENT

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro HOT_LOAD]
gcode:
	# Parameters
	{% set t = params.T|default(240)|int %}
	
	M104 S{t}
	PARKPURGE
	M109 S{t}
    LOAD_FILAMENT

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro CLEANNOZZLE]
gcode:
	# Parameters
	# Iterations
	{% set i = params.I|default(5)|int %}
	# Speed
	{% set s = params.S|default(100)|int %}
	
	CG28
	SAVE_GCODE_STATE NAME=CLEANNOZZLE
	G90																; absolute positioning
  G0 Z10 F1500
	G0 X260 Y312 F9000			                                    ; move to right of nozzle brush
	G0 Z5 F1500													    ; move down to nozzle brush
	{% for iteration in range(i|int) %}
		G0 X210 F{s*60}												; wipe back
		G0 X260	F{s*60}												; wipe forth
	{% endfor %}
	G0 X210	F{s*60}													; wipe back
	G0 Z10 F1500												    ; raise

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro SWIPENOZZLE]
gcode:
	CG28
	SAVE_GCODE_STATE NAME=SWIPENOZZLE
	G90																; absolute positioning
  G0 Z10 F900
	G0 X260 Y312 F9000 			                                    ; move to rear of nozzle brush
	G0 Z5	F1500													; lower
	G0 X210 F3000													; wipe forward
	G0 Z10	F1500												    ; raise
	RESTORE_GCODE_STATE NAME=SWIPENOZZLE

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                  FAN CONTROL
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[delayed_gcode NEVERMORE_OFF]############################################################################################################################################################################################################################
gcode:
  SET_FAN_SPEED FAN=nevermore SPEED=0

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro NEVERMORE_ADJUST]
gcode:
	# ABS
	{% if printer.heater_bed.target >= 100 %}
		SET_FAN_SPEED FAN=nevermore SPEED=0.5
	## PETG
	{% elif printer.heater_bed.target > 65 and printer.heater_bed.target < 100 %}
		SET_FAN_SPEED FAN=nevermore SPEED=0
	# PLA
	{% elif printer.heater_bed.target <= 65 %}
		SET_FAN_SPEED FAN=nevermore SPEED=0
	# Catch-all
	{% else %}
		SET_FAN_SPEED FAN=nevermore SPEED=0.5
  {% endif %}

  
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                CONDITIONAL HOMING
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Conditional G28 (home if not already homed)
[gcode_macro CG28]
gcode:
	{% if "xyz" not in printer.toolhead.homed_axes %}
		G28
	{% endif %}

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Conditional G28 (home if not already homed)
[gcode_macro XYCG28]
gcode:
	{% if "xy" not in printer.toolhead.homed_axes %}
		G28 X Y
	{% endif %}

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro ZCG28]
gcode:
	{% if "z" not in printer.toolhead.homed_axes %}
		G28 Z
	{% endif %}

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                  CHAMBER TEMP 
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro HEATSOAK]
gcode:
	# Parameters
	{% set t = params.T|default(110)|int %}
	{% set move = params.MOVE|default(1)|int %}

	UPDATE_DELAYED_GCODE ID=DELAYED_OFF DURATION=0      ; cancel off timer (if there is one)
	SET_FAN_SPEED FAN=nevermore SPEED=0.5		 		; turn on Nevermore
	M140 S{t}							                ; heat bed
	{% if t >= 100 %}
		M104 S160									    ; set hotend to no-ooze temp
		M106 S205 									    ; turn on part fan (80%)
	{% else %}
		M106 S0 									    ; turn part fan off
	{% endif %}
	{% if move == 1 %}
		CG28										    ; conditional home
		PARKCENTER						 			    ; move to bed
	{% endif %}


############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                  PARKING 
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Park front center
[gcode_macro PARKFRONT]
gcode:
	CG28                                  																						; home if not already homed
	SAVE_GCODE_STATE NAME=PARKFRONT
	G90                                   																						; absolute positioning
	G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+10} F9000	
  G0 Z{printer.toolhead.axis_maximum.z/2} F900
	RESTORE_GCODE_STATE NAME=PARKFRONT

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Park front center, but low down
[gcode_macro PARKFRONTLOW]
gcode:
	CG28                                  																						; home if not already homed
	SAVE_GCODE_STATE NAME=PARKFRONT
	G90                                   																						; absolute positioning
	G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+25} F9000		
  G0 Z20 F900							
	RESTORE_GCODE_STATE NAME=PARKFRONT

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Park top rear left
[gcode_macro PARKREAR]
gcode:
	CG28                                  																						; home if not already homed
	SAVE_GCODE_STATE NAME=PARKREAR
	G90                                   																						; absolute positioning
	G0 X{printer.toolhead.axis_minimum.x+10} Y{printer.toolhead.axis_maximum.y-10} F9000
  G0 Z{printer.toolhead.axis_maximum.z-50} F900		
	RESTORE_GCODE_STATE NAME=PARKREAR

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Park center of build volume
[gcode_macro PARKCENTER]
gcode:
	CG28                                  																						; home if not already homed
	SAVE_GCODE_STATE NAME=PARKCENTER
	G90                                   																						; absolute positioning
	G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F9000	
  G0 Z{printer.toolhead.axis_maximum.z/2} F900
	RESTORE_GCODE_STATE NAME=PARKCENTER

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Park 20mm above center of bed
[gcode_macro PARKBED]
gcode:
	CG28                                  																						; home if not already homed
	SAVE_GCODE_STATE NAME=PARKBED
	G90                                   																						; absolute positioning
	G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F9000
  G0 Z20 F900										
	RESTORE_GCODE_STATE NAME=PARKBED

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

  # Park at purge bucket
[gcode_macro PARKPURGE]
gcode:
	CG28                                  																						; home if not already homed
	SAVE_GCODE_STATE NAME=PARKPURGE
	G90                                   																						; absolute positioning
  G0 Z50 F900
	G0 X275 Y312 F9000								
	RESTORE_GCODE_STATE NAME=PARKPURGE

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                              Alias / Shortcuts
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Convert Marlin linear advance (M900) commands to Klipper (SET_PRESSURE_ADVANCE) commands.
# Used in conjunction with Marlin's linear advance calibration tool: 
# https://marlinfw.org/tools/lin_advance/k-factor.html
[gcode_macro M900]
gcode:
	# Parameters
	{% set pa = params.K|float %}
	
	SET_PRESSURE_ADVANCE ADVANCE={pa}

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Replace M109 (Wait for Hotend Temperature) with TEMPERATURE_WAIT so we don't have to wait for PID to level off.
[gcode_macro M109]
rename_existing: M99109
gcode:
	#Parameters
	{% set s = params.S|float %}
	
	M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+5}



############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                           SAFETY
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# Lower z stepper current (in case of crash). Referenced in my klicky homing overrides and in calibrate_z.
[gcode_macro LOWERCURRENT]
gcode:
	SET_TMC_CURRENT STEPPER=stepper_z CURRENT=0.45 #HOLDCURRENT=0.35
	SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT=0.45 #HOLDCURRENT=0.35
	SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT=0.45 #HOLDCURRENT=0.35
	#SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT=0.35 #HOLDCURRENT=0.35

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
	
# Returns z steppers back to their currents specified in the config.
[gcode_macro RESETCURRENT]
gcode:
	SET_TMC_CURRENT STEPPER=stepper_z CURRENT={printer.configfile.settings["tmc2209 stepper_z"].run_current} #HOLDCURRENT={printer.configfile.settings["tmc2209 stepper_z"].hold_current}
	SET_TMC_CURRENT STEPPER=stepper_z1 CURRENT={printer.configfile.settings["tmc2209 stepper_z1"].run_current} #HOLDCURRENT={printer.configfile.settings["tmc2209 stepper_z1"].hold_current}
	SET_TMC_CURRENT STEPPER=stepper_z2 CURRENT={printer.configfile.settings["tmc2209 stepper_z2"].run_current} #HOLDCURRENT={printer.configfile.settings["tmc2209 stepper_z2"].hold_current}
	#SET_TMC_CURRENT STEPPER=stepper_z3 CURRENT={printer.configfile.settings["tmc2209 stepper_z3"].run_current} HOLDCURRENT={printer.configfile.settings["tmc2209 stepper_z3"].hold_current}	

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro RESETSPEEDS]
gcode:
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} 
    SET_VELOCITY_LIMIT ACCEL={printer.configfile.settings.printer.max_accel}  
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel} 
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={printer.configfile.settings.printer.square_corner_velocity}

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro OFF]
gcode:
	M84												; turn steppers off
    TURN_OFF_HEATERS								; turn bed / hotend off
    M107                         	   			 	; turn print cooling fan off
#	SET_FAN_SPEED FAN=Exhaust SPEED=0  				; turn exhaust fan off
	SET_FAN_SPEED FAN=BedFans SPEED=0				; bed fan off
	SET_PIN PIN=caselight VALUE=0					; turn light off


############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[delayed_gcode DELAYED_OFF]
gcode:
	OFF  															; call "OFF" macro, to turn off everything (heaters, motors, lights, fans)


############################################################################################################################################################################################################################
############################################################################################################################################################################################################################
#                        FLUIDD WEB MACROS 
############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

# These are specified as macros just so they show up in Fluidd/Mainsail.

[gcode_macro SETPA]
gcode:
	# Parameters
	{% set pa = params.PA|default(0)|float %}

	SET_PRESSURE_ADVANCE ADVANCE={pa}

############################################################################################################################################################################################################################
############################################################################################################################################################################################################################

[gcode_macro SETPASMOOTH]
gcode:
	# Parameters
	{% set smooth = params.SMOOTH|default(0)|float %}
	
	SET_PRESSURE_ADVANCE SMOOTH_TIME={smooth}




